# ================================================
# ðŸ“Œ STEP 0: Upload Image
# ================================================
from google.colab import files
uploaded = files.upload()

import cv2
import numpy as np
import matplotlib.pyplot as plt
from PIL import Image
import tensorflow as tf
from tensorflow.keras.layers import Dense, Flatten, ReLU, GlobalAveragePooling2D
from tensorflow.keras.models import Sequential

# Automatically use uploaded file name
img_path = list(uploaded.keys())[0]
print("Loaded Image:", img_path)


# ================================================
# ðŸ“Œ STEP 1: Load & Resize Image
# ================================================
original_image = Image.open(img_path)

img = cv2.imread(img_path)
if img is None:
    raise ValueError("âŒ Image not loaded. Check filename or path.")

img = cv2.resize(img, (128, 128))


# ================================================
# ðŸ“Œ STEP 2: Preprocessing
# ================================================
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
normalized = (gray > 127).astype(np.float32)


# ================================================
# ðŸ“Œ STEP 3: Augmentation Functions
# ================================================
def rotate_image(img, angle):
    (h, w) = img.shape[:2]
    center = (w // 2, h // 2)
    M = cv2.getRotationMatrix2D(center, angle, 1.0)
    return cv2.warpAffine(img, M, (w, h))

def flip_horizontal(img):
    return cv2.flip(img, 1)

def flip_vertical(img):
    return cv2.flip(img, 0)

def zoom_in(img, zoom_factor=1.2):
    h, w = img.shape[:2]
    new_h, new_w = int(h / zoom_factor), int(w / zoom_factor)
    cropped = img[h//2 - new_h//2:h//2 + new_h//2, w//2 - new_w//2:w//2 + new_w//2]
    return cv2.resize(cropped, (w, h))

def adjust_brightness(img, factor=1.5):
    return np.clip(img * factor, 0, 1)

def apply_blur(img, ksize=3):
    return cv2.GaussianBlur(img, (ksize, ksize), 0)


# Apply augmentations
rotated_90 = rotate_image(normalized, 90)
rotated_60 = rotate_image(normalized, 60)
flipped_h = flip_horizontal(normalized)
flipped_v = flip_vertical(normalized)
zoomed = zoom_in(normalized)
bright = adjust_brightness(normalized, 1.5)
blurred = apply_blur(normalized)


# ================================================
# ðŸ“Œ STEP 4: Simple Neural Network
# ================================================
model = Sequential([
    tf.keras.Input(shape=(128, 128, 1)),
    Flatten(),
    Dense(256),
    ReLU(),
    Dense(64),
    ReLU(),
    Dense(10, activation='softmax')
])


# ================================================
# ðŸ“Œ STEP 5: Dimensionality Reduction
# ================================================
reducer = Sequential([
    tf.keras.Input(shape=(128, 128, 1)),
    GlobalAveragePooling2D()
])

input_img = np.expand_dims(normalized, axis=(0, -1))
reduced_vector = reducer.predict(input_img)


# ================================================
# ðŸ“Œ STEP 6: Dummy Model Training
# ================================================
model.compile(optimizer='adam',
              loss='sparse_categorical_crossentropy',
              metrics=['accuracy'])

history = model.fit(input_img, np.array([1]), epochs=10, verbose=0)


# ================================================
# ðŸ“Œ STEP 7: Display Original Image
# ================================================
plt.figure(figsize=(4, 4))
plt.imshow(original_image)
plt.title("Original Image")
plt.axis('off')
plt.show()


# ================================================
# ðŸ“Œ STEP 8: Display Augmented Images
# ================================================
fig, axs = plt.subplots(2, 4, figsize=(14, 7))

axs[0, 0].imshow(normalized, cmap='gray')
axs[0, 0].set_title("Normalized")
axs[0, 0].axis('off')

axs[0, 1].imshow(rotated_90, cmap='gray')
axs[0, 1].set_title("Rotated 90Â°")
axs[0, 1].axis('off')

axs[0, 2].imshow(rotated_60, cmap='gray')
axs[0, 2].set_title("Rotated 60Â°")
axs[0, 2].axis('off')

axs[0, 3].imshow(flipped_h, cmap='gray')
axs[0, 3].set_title("Flipped Horizontal")
axs[0, 3].axis('off')

axs[1, 0].imshow(flipped_v, cmap='gray')
axs[1, 0].set_title("Flipped Vertical")
axs[1, 0].axis('off')

axs[1, 1].imshow(zoomed, cmap='gray')
axs[1, 1].set_title("Zoomed In")
axs[1, 1].axis('off')

axs[1, 2].imshow(bright, cmap='gray')
axs[1, 2].set_title("Brightened")
axs[1, 2].axis('off')

axs[1, 3].imshow(blurred, cmap='gray')
axs[1, 3].set_title("Blurred")
axs[1, 3].axis('off')

plt.tight_layout()
plt.show()


# ================================================
# ðŸ“Œ STEP 9: Training Loss Plot
# ================================================
plt.plot(history.history['loss'], marker='o')
plt.title('Training Loss over Epochs')
plt.xlabel('Epoch')
plt.ylabel('Loss')
plt.grid(True)
plt.show()
